<html lang="de">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

	<link rel="icon" href="favicon.png" sizes="16x16" />
	<link rel="icon" href="img/favicon_194.png" sizes="192x192" />
	<link rel="apple-touch-icon" href="img/favicon_194.png" />
	<meta name="msapplication-TileImage" content="img/favicon_194.png" />

	<title>Klick Vitrinen Generator</title>
	<script src="lib/browser.maker.js"></script>
	<script type="text/javascript">
		var makerjs = require('makerjs');
	</script>
</head>
<body style="margin: 0px; ">
<div style="display: flex; flex-flow: row; background-color: #ffdc14; background: linear-gradient(135deg, rgba(255,205,0,1) 0%, rgba(255,220,20,1) 35%, rgba(255,205,0,1) 100%);padding-left: 20px; justify-content: space-between;height:100px">
	<div style="display: flex; flex-flow: column;">
		<h1 style="display: flex;margin-top: 5px;margin-bottom: 2px;font-family: Khand, Helvetia, Arial, sans-serif; font-size: 34px; font-weight: 600; color:#000000;">Click Vitrinen Generator</h1>
		<div style="display: flex; margin-top: 0px;margin-bottom: 15px;">Version 1.1.3 &nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;23.11.2022 by Gassi</div>
	</div>
	<img src="img/td_header.png" height="150px" style="; display: flex; justify-content: right; align-self: center;filter: drop-shadow(8px 8px 40px #FFB214);">
</div>

	<div id="clickCabinetPreviewDiv" name="clickCabinetPreviewDiv" ></div>
<br><br>

<div style="width: 700px">
	<div id="guiElements" style="display: flex; flex-flow: column; ">
		<div style="background-color: aliceblue;height: fit-content;clear: both; width: 100%;display: table;">
			<div style='font-weight: bold; margin-left: 15px; margin-bottom: 8px;'>Vitrine LxBxH</div>

			<div style="display: flex; flex-flow: column">

				<div style="display: flex; flex-flow: row;">
					<div style="flex-basis: 100px; justify-content: right; display: flex; margin-right: 8px"> </div>
					<div style="display: flex; width: 80px;font-weight: bold; align-items: center;">Innenmaße</div>
					<span style="margin-left: 8px; width:25px"></span>
					<div style="margin-left: 30px; width: 90px; align-items: center; display: flex">Außenmaße</div>
					<div style="display: flex; margin-left: 10px; flex-flow: column">
						<div style="display: flex;"><span style="width: 165px; display: flex">Totale Länge des Pfades: </span><span style="margin-left: 5px; width: 65px" id="modellength"></span><span>mm</span><br></div>
						<div style="display: flex;"><span style="width: 165px; display: flex">Fläche der Rechtecke:</span><span style="margin-left: 5px; width: 65px" id="surfaceArea"></span><span>m²</span></div>
					</div>
				</div>

				<div style="display: flex; flex-flow: row;">
					<div style="flex-basis: 100px; justify-content: right; display: flex; margin-right: 8px"><label for="cabinetLength">L: </label></div>
					<input type="number" value="350" min="50" max="1000" id="cabinetLength" name="cabinetLength" onchange="cabinetLengthChanged()" style="width: 80px">
					<span style="margin-left: 8px; width:25px">mm</span>
					<div id="cabinetLengthOutsideDimension" style="margin-left: 30px; width: 70px"></div>
					<div id="cabinetLengthErrorMsg" style="margin-left: 30px; color: #ff0000"></div>
				</div>
				<div style="display: flex; flex-flow: row;">
					<div style="flex-basis: 100px; justify-content: right; display: flex; margin-right: 8px"><label for="cabinetWidth">B: </label></div>
					<input type="number" value="140" min="50" max="1000" id="cabinetWidth" name="cabinetWidth" onchange="cabinetWidthChanged()" style="width: 80px">
					<span style="margin-left: 8px; width:25px">mm</span>
					<div id="cabinetWidthOutsideDimension" style="margin-left: 30px; width: 70px "></div>
					<div id="cabinetWidthErrorMsg" style="margin-left: 10px; color: #ff0000"></div>
				</div>
				<div style="display: flex; flex-flow: row;">
					<div style="flex-basis: 100px; justify-content: right; display: flex; margin-right: 8px"><label for="cabinetHeight">H: </label></div>
					<input type="number" value="110" min="50" max="1000" id="cabinetHeight" name="cabinetHeight" onchange="cabinetHeightChanged()" style="width: 80px">
					<span style="margin-left: 8px; width:25px">mm</span>
					<div id="cabinetHeightOutsideDimension" style="margin-left: 30px; width: 70px; "></div>
					<div id="cabinetHeightErrorMsg" style="margin-left: 10px; color: #ff0000"></div>
				</div>
				<div style="display: flex; flex-flow: row;">
					<div style="flex-basis: 100px; justify-content: right; display: flex; margin-right: 8px"><label for="processAlsoFloor">Mit Boden:</label></div>
					<input type="checkbox" id="processAlsoFloor" name="processAlsoFloor" onchange="processAlsoFloorChanged()" style="display: flex; justify-content: left; margin-left: 0">
				</div>
				<div style="display: flex; flex-flow: row;">
					<div style="flex-basis: 100px; justify-content: right; display: flex; margin-right: 8px"><label for="helperLines">Hilfslinien: </label></div>
					<input type="checkbox" id="helperLines" name="helperLines" onchange="helperLinesChanged()" style="display: flex; justify-content: left; margin-left: 0">
				</div>
				<div style="display: flex; flex-flow: row;">
					<div style="flex-basis: 100px; justify-content: right; display: flex; margin-right: 8px ">Materialdicke: </div>
					<div style="display: flex; justify-content: left; margin-left: 0; flex-flow: column">
						<div style="display: flex; justify-content: left; margin-left: 0">
							<input type="radio" id="ratio1dot5mm" name="materialThicknessRadio" value="1.5" onchange="materialThicknessChanged()" style="margin-left: 0; display: flex">
							<span style="margin-left: 8px"><label for="ratio1dot5mm">1.5 mm</label></span>
						</div>
						<div style="display: flex; justify-content: left; margin-left: 0">
							<input type="radio" id="ratio2mm" name="materialThicknessRadio" value="2" onchange="materialThicknessChanged()" style="margin-left: 0; display: flex">
							<span style="margin-left: 8px"><label for="ratio2mm">2 mm</label></span>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="exportButtons" style="background-color: cornsilk; display:flex; padding-top:10px; padding-bottom:10px; justify-content : space-around">
			<button id="downloadDXF" onclick="downloadDXF()" style="display: flex; flex-grow: 1; margin-left: 5px; margin-right: 5px" title="Generiere und download eine DXF Datei"> DXF Download</button>
			<button id="downloadSVG" onclick="downloadSVG()" style="display: flex; flex-grow: 1; margin-left: 5px; margin-right: 5px" title="Generiere und download eine SVG Datei"> SVG Download</button>
		</div>

		<div id="debugInfosOuter" style="background-color: cadetblue; display: flex; flex-flow: column">
			<div style="padding-left: 15px; padding-top: 15px; display: flex" id="debugInfosHeadline">Debug Infos: <a id="linkShowDebugInfos" style="margin-left:15px;font-family: monospace; text-decoration: none; color: #000000" href="javascript:openDebugInfos();"> [+] </a></div>
			<div style="padding-left:15px; padding-top: 3px;display: none" id="debugInfosInner"></div>
		</div>
	</div>
</div>
<script type="text/javascript">

	function openDebugInfos() {

		let displayVal = document.getElementById("debugInfosInner").style.display;

		if (displayVal === "none") {
			document.getElementById("debugInfosInner").style.display = "flex";
			document.getElementById("linkShowDebugInfos").innerHTML = " [-]";
		} else {
			document.getElementById("debugInfosInner").style.display = "none";
			document.getElementById("linkShowDebugInfos").innerHTML = " [+]";
		}
		//linkShowDebugInfos
	}

var makerjs = require('makerjs');
var model;

var metadata = {
	// calculated Values...

	cabinetLength : 0,
	cabinetWidth : 0,
	cabinetHeight : 0,

	cabinetLengthNumberOfElements : 0,
	cabinetWidthNumberOfElements : 0,
	cabinetHeightNumberOfElements : 0,

	cabinetLengthMmOfLongElement : 0,
	cabinetWidthMmOfLongElement : 0,
	cabinetHeightMmOfLongElement : 0,

	cabinetLengthStartEndElementLengthMm : 0,
	cabinetWidthStartEndElementLengthMm : 0,
	cabinetHeightStartEndElementLengthMm : 0,

	diffInnenAussen : 0,
	nettoDelta : 0,
	nettoDeltaHalf : 0,

	totalHeight : 0,
	totalWidth : 0,

	insideClipLargerThanOutsideClipHalf : 0,
	insideClipLargerThanOutsideClipQuarter : 0,

	modellength : 0,

	// const values

	minSideLength : 50,
	maxSideLength : 1000,

	radius1 : 0.2,
	radius2 : 0.2,
	radius3 : 0.2,
	radius4 : 1.1,

	radiusInClickCornerLarge : 3.1,
	radiusInClickCornerSmall : 1.1,

	length1WithoutMaterialThickness : -0.6,
	length1 : -100,  // with material thickness 1.5 mm length1 == 0.9
	length2 : 0.1,
	length3 : 0,
	borderSpace : 5,
	insideClipLargerThanOutsideClip : 0.4,

	// preconfigured values
	processAlsoFloor : false,
	materialThickness : 1.5,
	helperLines : false,
};

document.addEventListener("DOMContentLoaded", function() {
	createModel();
	drawPreview();
	document.getElementById('cabinetLength').focus();
});



function createModel() {

	calculateMetadata();

	initModel();

	model.units = makerjs.unitType.Millimeter;

	createHelperLinesIfNeeded();

	fillDebugInfoArea();

	createFirstElement();

	createSecondElement();

	createThirdElement();

	cloneElements();

	computeLength();

}

function computeLength() {
	let sumModelLength = 0;
	for (const key in model.models) {
		let currentElementModel = model.models[key];
		let currentModelLength = makerjs.measure.modelPathLength(currentElementModel);
		console.log(key + "= " + currentModelLength);
		sumModelLength += currentModelLength;
	}
	metadata.modellength = sumModelLength;
}

function cloneElements() {
	let cloneShift = Math.max(metadata.cabinetWidth, metadata.cabinetLength) + (2 * metadata.borderSpace);

	cloneElement(model.models.firstElement, "clonedFirstElement", cloneShift);

	cloneElement(model.models.secondElement, "clonedSecondElement", cloneShift);

	if (metadata.processAlsoFloor) {
		cloneElement(model.models.thirdElement, "clonedThirdElement", cloneShift);
	}
}

function cloneElement(toCloneElement, cloneElementName, cloneShift) {
	let clone = makerjs.model.clone(toCloneElement);
	makerjs.model.move(clone, [cloneShift, 0]);
	model.models[cloneElementName] = clone;
}

function createFirstElement() {
	let heightLeftFirstElement = makerjs.importer.fromSVGPathData(createHeight(metadata.borderSpace + metadata.diffInnenAussen, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight, true));
	let heightRightFirstElement = makerjs.importer.fromSVGPathData(createHeight(metadata.borderSpace + metadata.cabinetWidth, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight, false));

	let widthLowerFirstElement = makerjs.importer.fromSVGPathData(createWidth(metadata.borderSpace + metadata.diffInnenAussen + metadata.radiusInClickCornerSmall, metadata.cabinetHeight - metadata.totalHeight + metadata.borderSpace - metadata.diffInnenAussen, true, false));

	let radius1FirstElement = makerjs.importer.fromSVGPathData(createRadiusLeftUpperSvgPath(metadata.borderSpace + metadata.diffInnenAussen, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight + (metadata.processAlsoFloor ? metadata.diffInnenAussen : 0), metadata.radiusInClickCornerSmall));
	let radius2FirstElement = makerjs.importer.fromSVGPathData(createRadiusRightUpperSvgPath(metadata.borderSpace + metadata.cabinetWidth - metadata.radiusInClickCornerSmall, metadata.borderSpace - metadata.totalHeight + (metadata.processAlsoFloor ? metadata.diffInnenAussen : 0), metadata.radiusInClickCornerSmall));
	let radius3FirstElement = makerjs.importer.fromSVGPathData(createRadiusLeftLowerSvgPath(metadata.borderSpace + metadata.diffInnenAussen, metadata.borderSpace + metadata.cabinetHeight - metadata.totalHeight - metadata.diffInnenAussen - metadata.radiusInClickCornerSmall, metadata.radiusInClickCornerSmall));
	let radius4FirstElement = makerjs.importer.fromSVGPathData(createRadiusRightLowerSvgPath(metadata.borderSpace + metadata.cabinetWidth, metadata.borderSpace - metadata.totalHeight + metadata.cabinetHeight - metadata.diffInnenAussen - metadata.radiusInClickCornerSmall, metadata.radiusInClickCornerSmall));

	let widthUpperFirstElement;
	if (!metadata.processAlsoFloor) {
		widthUpperFirstElement = makerjs.importer.fromSVGPathData(createStartPos(metadata.borderSpace + metadata.diffInnenAussen + metadata.radiusInClickCornerSmall, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight - metadata.radiusInClickCornerSmall) + createHorizontalSvgPath(metadata.cabinetWidth - metadata.diffInnenAussen - metadata.radiusInClickCornerSmall - metadata.radiusInClickCornerSmall));
	} else {
		widthUpperFirstElement = makerjs.importer.fromSVGPathData(createWidth(metadata.borderSpace + metadata.diffInnenAussen + metadata.radiusInClickCornerSmall, -metadata.totalHeight + metadata.borderSpace + metadata.diffInnenAussen, false, false));
	}

	model.models["firstElement"] = combine(radius1FirstElement, widthUpperFirstElement, radius2FirstElement, heightRightFirstElement,
			radius3FirstElement, widthLowerFirstElement, radius4FirstElement, heightLeftFirstElement);
}

function createSecondElement() {
	let hightLeftSecondElement = makerjs.importer.fromSVGPathData(createHeight(metadata.borderSpace + metadata.diffInnenAussen, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight + metadata.cabinetHeight + metadata.borderSpace, true));
	let hightRightSecondElement = makerjs.importer.fromSVGPathData(createHeight(metadata.borderSpace + metadata.cabinetLength, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight + metadata.cabinetHeight + metadata.borderSpace, false));

	let widthLowerSecondElement = makerjs.importer.fromSVGPathData(createLength(metadata.borderSpace + metadata.diffInnenAussen + metadata.radiusInClickCornerSmall, metadata.cabinetHeight + metadata.cabinetHeight + metadata.borderSpace - metadata.totalHeight + metadata.borderSpace - metadata.diffInnenAussen, true, false));

	let radius1SecondElement = makerjs.importer.fromSVGPathData(createRadiusLeftUpperSvgPath(metadata.borderSpace + metadata.diffInnenAussen, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight + metadata.cabinetHeight + metadata.borderSpace + (metadata.processAlsoFloor ? metadata.diffInnenAussen : 0), metadata.radiusInClickCornerSmall));
	let radius2SecondElement = makerjs.importer.fromSVGPathData(createRadiusRightUpperSvgPath(metadata.borderSpace + metadata.cabinetLength - metadata.radiusInClickCornerSmall, metadata.borderSpace - metadata.totalHeight + metadata.cabinetHeight + metadata.borderSpace + (metadata.processAlsoFloor ? metadata.diffInnenAussen : 0), metadata.radiusInClickCornerSmall));
	let radius3SecondElement = makerjs.importer.fromSVGPathData(createRadiusLeftLowerSvgPath(metadata.borderSpace + metadata.diffInnenAussen, metadata.borderSpace + metadata.cabinetHeight - metadata.totalHeight - metadata.diffInnenAussen - metadata.radiusInClickCornerSmall + metadata.cabinetHeight + metadata.borderSpace, metadata.radiusInClickCornerSmall));
	let radius4SecondElement = makerjs.importer.fromSVGPathData(createRadiusRightLowerSvgPath(metadata.borderSpace + metadata.cabinetLength, metadata.borderSpace - metadata.totalHeight + metadata.cabinetHeight - metadata.diffInnenAussen - metadata.radiusInClickCornerSmall + metadata.cabinetHeight + metadata.borderSpace, metadata.radiusInClickCornerSmall));

	let widthUpperSecondElement;
	if (!metadata.processAlsoFloor) {
		widthUpperSecondElement = makerjs.importer.fromSVGPathData(createStartPos(metadata.borderSpace + metadata.diffInnenAussen + metadata.radiusInClickCornerSmall, metadata.borderSpace + metadata.radiusInClickCornerSmall - metadata.totalHeight - metadata.radiusInClickCornerSmall + metadata.borderSpace + metadata.cabinetHeight) + createHorizontalSvgPath(metadata.cabinetLength - metadata.diffInnenAussen - metadata.radiusInClickCornerSmall - metadata.radiusInClickCornerSmall));
	} else {
		widthUpperSecondElement = makerjs.importer.fromSVGPathData(createLength(metadata.borderSpace + metadata.diffInnenAussen + metadata.radiusInClickCornerSmall, metadata.cabinetHeight + metadata.borderSpace + metadata.borderSpace + metadata.diffInnenAussen - metadata.totalHeight, false, false));
	}

	model.models["secondElement"] = combine(radius1SecondElement, widthUpperSecondElement, radius2SecondElement,
			hightRightSecondElement, radius3SecondElement, widthLowerSecondElement, radius4SecondElement, hightLeftSecondElement);
}

function createThirdElement() {
	let lengthUpperThirdElement = makerjs.importer.fromSVGPathData(createLength(metadata.borderSpace + metadata.radiusInClickCornerLarge, metadata.cabinetHeight + metadata.cabinetHeight + metadata.borderSpace + metadata.borderSpace - metadata.totalHeight + metadata.borderSpace, false, true));
	let lengthLowerThirdElement = makerjs.importer.fromSVGPathData(createLength(metadata.borderSpace + metadata.radiusInClickCornerLarge, metadata.cabinetHeight + metadata.cabinetHeight + metadata.cabinetWidth + metadata.borderSpace + metadata.borderSpace - metadata.totalHeight + metadata.borderSpace, true, true));

	let widthLeftThirdElement = makerjs.importer.fromSVGPathData(createWidth(metadata.borderSpace, metadata.cabinetHeight + metadata.cabinetHeight + metadata.borderSpace + metadata.borderSpace + metadata.borderSpace + metadata.radiusInClickCornerLarge - metadata.totalHeight, true, true));
	let widthRightThirdElement = makerjs.importer.fromSVGPathData(createWidth(metadata.borderSpace + metadata.cabinetLength, metadata.cabinetHeight + metadata.cabinetHeight + metadata.borderSpace + metadata.borderSpace + metadata.borderSpace + metadata.radiusInClickCornerLarge - metadata.totalHeight, false, true));

	let radius1ThirdElement = makerjs.importer.fromSVGPathData(createRadiusLeftUpperSvgPath(metadata.borderSpace, metadata.borderSpace + metadata.radiusInClickCornerLarge - metadata.totalHeight + metadata.cabinetHeight + metadata.cabinetHeight + metadata.borderSpace + metadata.borderSpace, metadata.radiusInClickCornerLarge));
	let radius2ThirdElement = makerjs.importer.fromSVGPathData(createRadiusRightUpperSvgPath(metadata.borderSpace + metadata.cabinetLength - metadata.radiusInClickCornerLarge, metadata.borderSpace - metadata.totalHeight + metadata.cabinetHeight + metadata.cabinetHeight + metadata.borderSpace + metadata.borderSpace, metadata.radiusInClickCornerLarge));
	let radius3ThirdElement = makerjs.importer.fromSVGPathData(createRadiusLeftLowerSvgPath(metadata.borderSpace, metadata.borderSpace + metadata.cabinetHeight - metadata.totalHeight - metadata.radiusInClickCornerLarge + metadata.cabinetHeight + metadata.cabinetWidth + metadata.borderSpace + metadata.borderSpace, metadata.radiusInClickCornerLarge));
	let radius4ThirdElement = makerjs.importer.fromSVGPathData(createRadiusRightLowerSvgPath(metadata.borderSpace + metadata.cabinetLength, metadata.borderSpace - metadata.totalHeight + metadata.cabinetHeight - metadata.radiusInClickCornerLarge + metadata.cabinetHeight + metadata.cabinetWidth + metadata.borderSpace + metadata.borderSpace, metadata.radiusInClickCornerLarge));

	model.models["thirdElement"] = combine(radius1ThirdElement, lengthUpperThirdElement, radius2ThirdElement, widthRightThirdElement, radius3ThirdElement,
		lengthLowerThirdElement, radius4ThirdElement, widthLeftThirdElement);
}

function createWidth(startX, startY, flag, floor) {
	let currentPath = createStartPos(startX, startY);

	if (floor) {
		let firstLinePathLength = metadata.cabinetWidthStartEndElementLengthMm - metadata.radiusInClickCornerLarge - metadata.nettoDeltaHalf - metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createVerticalSvgPath(firstLinePathLength);
	} else {
		let firstLinePathLength = metadata.cabinetWidthStartEndElementLengthMm - metadata.radiusInClickCornerSmall - metadata.diffInnenAussen - metadata.nettoDeltaHalf + metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createHorizontalSvgPath(firstLinePathLength);
	}

	for (let i = 0; i < (metadata.cabinetWidthNumberOfElements - 2); i++) {
		let cabinetWidthMmOfLongElementLocal = metadata.cabinetWidthMmOfLongElement;
		if (((i+1) % 2) === 0) {
			if (floor) {
				if (flag) {
					currentPath += createLeftLeftSvgPath();
					cabinetWidthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createRightRightSvgPath();
					cabinetWidthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				}
			} else {
				if (flag) {
					currentPath += createLowerUpSvgPath();
					cabinetWidthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createUpperDownSvgPath();
					cabinetWidthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				}
			}
		} else {
			if (floor) {
				if (flag) {
					currentPath += createLeftRightSvgPath();
					cabinetWidthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createRightLeftSvgPath();
					cabinetWidthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				}
			} else {
				if (flag) {
					currentPath += createLowerDownSvgPath();
					cabinetWidthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createUpperUpSvgPath();
					cabinetWidthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				}
			}
		}

		if (floor) {
			currentPath += createVerticalSvgPath(cabinetWidthMmOfLongElementLocal);
		} else {
			currentPath += createHorizontalSvgPath(cabinetWidthMmOfLongElementLocal);
		}
	}

	if (floor) {
		if (flag) {
			currentPath += createLeftLeftSvgPath();
		} else {
			currentPath += createRightRightSvgPath();
		}
	} else {
		if (flag) {
			currentPath += createLowerUpSvgPath();
		} else {
			currentPath += createUpperDownSvgPath();
		}
	}

	if (floor) {
		let lastLinePathLength = metadata.cabinetWidthStartEndElementLengthMm - metadata.radiusInClickCornerLarge - metadata.nettoDeltaHalf - metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createVerticalSvgPath(lastLinePathLength);
	} else {
		let lastLinePathLength = metadata.cabinetWidthStartEndElementLengthMm - metadata.radiusInClickCornerSmall - metadata.nettoDeltaHalf + metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createHorizontalSvgPath(lastLinePathLength);
	}
	return currentPath;
}

function createLength(startX, startY, flag, floor) {
	let currentPath = createStartPos(startX, startY);

	if (floor) {
		let firstLinePathLength = metadata.cabinetLengthStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.radiusInClickCornerLarge - metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createHorizontalSvgPath(firstLinePathLength);
	} else {
		let firstLinePathLength = metadata.cabinetLengthStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.diffInnenAussen - metadata.radiusInClickCornerSmall + metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createHorizontalSvgPath(firstLinePathLength);
	}


	for (let i = 0; i < (metadata.cabinetLengthNumberOfElements - 2); i++) {
		let cabinetLengthMmOfLongElementLocal = metadata.cabinetLengthMmOfLongElement;
		if (((i+1) % 2) === 0) {
			if (floor) {
				if (flag) {
					currentPath += createLowerDownSvgPath();
					cabinetLengthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createUpperUpSvgPath();
					cabinetLengthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				}
			} else {
				if (flag) {
					currentPath += createLowerUpSvgPath();
					cabinetLengthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createUpperDownSvgPath();
					cabinetLengthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				}
			}
		} else {
			if (floor) {
				if (flag) {
					currentPath += createLowerUpSvgPath();
					cabinetLengthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createUpperDownSvgPath();
					cabinetLengthMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
				}
			} else {
				if (flag) {
					currentPath += createLowerDownSvgPath();
					cabinetLengthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				} else {
					currentPath += createUpperUpSvgPath();
					cabinetLengthMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
				}
			}
		}
		currentPath += createHorizontalSvgPath(cabinetLengthMmOfLongElementLocal);
	}

	if (floor) {
		if (flag) {
			currentPath += createLowerDownSvgPath()
		} else {
			currentPath += createUpperUpSvgPath();
		}
	} else {
		if (flag) {
			currentPath += createLowerUpSvgPath();
		} else {
			currentPath += createUpperDownSvgPath();
		}
	}
	
	if (floor) {
		let lastLinePathLength = metadata.cabinetLengthStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.radiusInClickCornerLarge - metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createHorizontalSvgPath(lastLinePathLength);
	} else {
		let lastLinePathLength = metadata.cabinetLengthStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.radiusInClickCornerSmall + metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createHorizontalSvgPath(lastLinePathLength);
	}

	return currentPath;
}

function createHeight(startX, startY, left) {
	if (metadata.processAlsoFloor) {
		startY += metadata.diffInnenAussen;
	}

	let currentPath = createStartPos(startX, startY);

	if (left) {
		let firstLinePathLength = metadata.cabinetHeightStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.radiusInClickCornerSmall + metadata.insideClipLargerThanOutsideClipQuarter;
		if (metadata.processAlsoFloor) {
			firstLinePathLength -= metadata.diffInnenAussen;
		}
		currentPath += createVerticalSvgPath(firstLinePathLength);
	} else {
		let firstLinePathLength = metadata.cabinetHeightStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.radiusInClickCornerSmall - metadata.insideClipLargerThanOutsideClipQuarter;
		if (metadata.processAlsoFloor) {
			firstLinePathLength -= metadata.diffInnenAussen;
		}
		currentPath += createVerticalSvgPath(firstLinePathLength);
	}

	for (let i = 0; i < (metadata.cabinetHeightNumberOfElements - 2); i++) {
		let cabinetHeightMmOfLongElementLocal = metadata.cabinetHeightMmOfLongElement;
		if (((i+1) % 2) === 0) {
			if (left) {
				currentPath += createLeftRightSvgPath();
				cabinetHeightMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
			} else {
				currentPath += createRightRightSvgPath();
				cabinetHeightMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
			}
		} else {
			if (left) {
				currentPath += createLeftLeftSvgPath();
				cabinetHeightMmOfLongElementLocal -= metadata.insideClipLargerThanOutsideClipHalf;
			} else {
				currentPath += createRightLeftSvgPath();
				cabinetHeightMmOfLongElementLocal += metadata.insideClipLargerThanOutsideClipHalf;
			}
		}
		currentPath += createVerticalSvgPath(cabinetHeightMmOfLongElementLocal);
	}

	if (left) {
		currentPath += createLeftRightSvgPath()
	} else {
		currentPath += createRightRightSvgPath();
	}
	if (left) {
		let lastLinePathLength = metadata.cabinetHeightStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.radiusInClickCornerSmall - metadata.diffInnenAussen + metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createVerticalSvgPath(lastLinePathLength);
	} else {
		let lastLinePathLength = metadata.cabinetHeightStartEndElementLengthMm - metadata.nettoDeltaHalf - metadata.radiusInClickCornerSmall - metadata.diffInnenAussen - metadata.insideClipLargerThanOutsideClipQuarter;
		currentPath += createVerticalSvgPath(lastLinePathLength);
	}
	return currentPath;
}

	function combine(...args) {
		if (args.length === 0) {
			throw "Invalid empty Argument!";
		}

		if (args.length === 1) {
			return args[0];
		}

		let combination = makerjs.model.combine(args[0], args[1], true, true, true, true, createOpts());

		if (args.length === 2) {
			return combination;
		}

		for (var i = 2; i < arguments.length; i++) {
			combination = makerjs.model.combine(combination, args[i], true, true, true, true, createOpts());
		}

		return combination;
	}


	function createOpts() {
		return  {
			trimDeadEnds: false,
			pointMatchingDistance: 2,
			out_deleted: [{ paths: {} }, { paths: {} }]
		};
	}

function createHelperLinesIfNeeded() {
	if (metadata.helperLines) {
		createRectangle("side1", metadata.cabinetWidth, metadata.cabinetHeight, metadata.borderSpace, metadata.cabinetHeight + metadata.cabinetWidth + metadata.borderSpace + metadata.borderSpace + metadata.borderSpace);
		createRectangle("side2", metadata.cabinetLength, metadata.cabinetHeight, metadata.borderSpace, metadata.cabinetWidth + metadata.borderSpace + metadata.borderSpace);
		createRectangle("top", metadata.cabinetLength, metadata.cabinetWidth, metadata.borderSpace, metadata.borderSpace);
	}
}

function fillDebugInfoArea() {
	document.getElementById('debugInfosInner').innerHTML =
			"<pre style='margin-top: 5px'>metaData: " + JSON.stringify(metadata, null, 2) + "\n\n</pre>";
}

function createRectangle(deterministicName, width, height, startx, starty) {
	model.paths[deterministicName + "_1"] = new makerjs.paths.Line([startx, starty], [startx + width, starty]);
	model.paths[deterministicName + "_2"] = new makerjs.paths.Line([startx, starty + height], [startx + width, starty + height]);
	model.paths[deterministicName + "_3"] = new makerjs.paths.Line([startx, starty], [startx, starty + height]);
	model.paths[deterministicName + "_4"] = new makerjs.paths.Line([startx + width, starty], [startx + width, starty + height]);
}

function calculateMetadata() {
	metadata.length1 = metadata.length1WithoutMaterialThickness + metadata.materialThickness;

	metadata.nettoDelta = metadata.radius4 - metadata.radius3 - metadata.length2 -  metadata.radius2 + metadata.radius1;
	metadata.nettoDeltaHalf = metadata.nettoDelta / 2;
	metadata.diffInnenAussen = metadata.radius1 + metadata.length1 + metadata.radius2 + metadata.radius3 + metadata.length3 + metadata.radius4;

	metadata.insideClipLargerThanOutsideClipHalf = metadata.insideClipLargerThanOutsideClip / 2;
	metadata.insideClipLargerThanOutsideClipQuarter = metadata.insideClipLargerThanOutsideClip / 4;

	cabinetLengthChanged(false);
	cabinetWidthChanged(false);
	cabinetHeightChanged(false);

	metadata.totalHeight = metadata.cabinetHeight + metadata.cabinetHeight + metadata.cabinetWidth + (4 * metadata.borderSpace);
	metadata.totalWidth = (Math.max(metadata.cabinetWidth, metadata.cabinetLength) + (2 * metadata.borderSpace)) * 2 + metadata.borderSpace;
	
	metadata.cabinetLengthNumberOfElements = determineNoOfElementsIncludingTheHalf(metadata.cabinetLength);
	metadata.cabinetWidthNumberOfElements  = determineNoOfElementsIncludingTheHalf(metadata.cabinetWidth);
	metadata.cabinetHeightNumberOfElements = determineNoOfElementsIncludingTheHalf(metadata.cabinetHeight);

	metadata.cabinetLengthMmOfLongElement = (metadata.cabinetLength / (metadata.cabinetLengthNumberOfElements - 1)) - metadata.nettoDelta;
	metadata.cabinetWidthMmOfLongElement  = (metadata.cabinetWidth  / (metadata.cabinetWidthNumberOfElements  - 1)) - metadata.nettoDelta;
	metadata.cabinetHeightMmOfLongElement = (metadata.cabinetHeight / (metadata.cabinetHeightNumberOfElements - 1)) - metadata.nettoDelta;

	metadata.cabinetLengthStartEndElementLengthMm = ((metadata.cabinetLength / (metadata.cabinetLengthNumberOfElements - 1)) / 2);
	metadata.cabinetWidthStartEndElementLengthMm  = ((metadata.cabinetWidth / (metadata.cabinetWidthNumberOfElements - 1)) / 2);
	metadata.cabinetHeightStartEndElementLengthMm = ((metadata.cabinetHeight / (metadata.cabinetHeightNumberOfElements - 1)) / 2);
}

function drawPreview() {
	var svg = makerjs.exporter.toSVG(model, {svgAttrs : {"width" : metadata.totalWidth + "px", "height" : metadata.totalHeight + "px", "id" : "preViewSvg" } });
		
	document.getElementById('clickCabinetPreviewDiv').innerHTML = "<div id='backgroundDiv'></div>";
	
	document.getElementById('backgroundDiv').innerHTML = "<div id='contentDiv' style='margin-left: 10px; margin-top: 10px;padding-top:12px; padding-left:12px; border-width: 1px; border-style: solid; border-color: #cdcdcd; width: fit-content;'></div>";
	
	document.getElementById('contentDiv').innerHTML = svg;
	document.getElementById('contentDiv').style.position = "relative";

	let viewBoxAttrib = "-1 -1 " + (metadata.totalWidth + 2) + " " + (metadata.totalHeight + 2) ;
	document.getElementById('preViewSvg').setAttribute("viewBox", viewBoxAttrib);

	let g = document.querySelector('#preViewSvg>g');
	g.style="stroke-width:0.05mm";

	document.getElementById('downloadDXF').style.visibility = "";
	document.getElementById('downloadSVG').style.visibility = "";

	document.getElementById("cabinetLength").value = parseInt(metadata.cabinetLength - (2 * metadata.diffInnenAussen));
	document.getElementById("cabinetWidth").value = parseInt(metadata.cabinetWidth - (2 * metadata.diffInnenAussen));
	document.getElementById("cabinetHeight").value = parseInt(metadata.cabinetHeight - (2 * metadata.diffInnenAussen));
	document.getElementById("processAlsoFloor").checked = metadata.processAlsoFloor;
	document.getElementById("helperLines").checked = metadata.helperLines;

	checkMaterialThicknessRadioButton(metadata.materialThickness);

	document.getElementById("modellength").innerHTML = " " + metadata.modellength.toFixed(2);


	document.getElementById("surfaceArea").innerHTML = (calculateSurfaceArea() / (1000 * 1000)).toFixed(4);
}

function initModel() {
	model = {
		paths: {},
		models: {}
	};
}

function calculateSurfaceArea() {
	return (2 * metadata.cabinetHeight * metadata.cabinetWidth) +
			(2 * metadata.cabinetHeight * metadata.cabinetLength) +
			((metadata.processAlsoFloor ? 2 : 1) * metadata.cabinetWidth * metadata.cabinetLength);
}

function checkMaterialThicknessRadioButton(materialThickness) {
	switch (materialThickness) {
		case (1.5):
			document.getElementById("ratio1dot5mm").checked = true;
			break;
		case (2):
			document.getElementById("ratio2mm").checked = true;
			break;
		default:
			alert("MaterialdickeError");
	}
}

/**
 * @param edgeLengthInMM edge length in mm
 * @returns number of shackles
 * 				__----__                    == 3
 * 				__----____----__            == 5
 *				__----____----____----__    == 7
 */
function determineNoOfElementsIncludingTheHalf(edgeLengthInMM) {
	let numberOfElements = Math. trunc(edgeLengthInMM / 25);
	if ((numberOfElements % 2) === 1) {
		numberOfElements--;
	}
	let sizeOfElement = edgeLengthInMM / numberOfElements;
	if (sizeOfElement > 45) {
		numberOfElements += 2;
		//sizeOfElement = edgeLengthInMM / numberOfElements;
	}
	return numberOfElements + 1; // "split" the first half and the last half as calculated Elements
}

/*********************************************** SVG Path Elements BEGIN **********************************************/

function createHorizontalSvgPath(length) {
	return "h " + length + " ";
}

function createVerticalSvgPath(length) {
	return "v " + length + " ";
}

function createStartPos(x, y) {
	return "M " + x + " " + y + " ";
}

function createUpperUpSvgPath() {
	let upperUp = "";
	upperUp += "m xx1,xy1 ";
	upperUp += "a xr1 xr1 0 0 0  xr1 -xr1 ";
	upperUp += "v -xl1 ";
	upperUp += "a xr2 xr2 0 0 0 -xr2 -xr2 ";
	upperUp += "h -xl2 ";
	upperUp += "a xr3 xr3 0 0 1 -xr3 -xr3 ";
	upperUp += "v -xl3 ";
	upperUp += "a xr4 xr4 0 0 1  xr4 -xr4 ";
	return replaceValues(upperUp);
}

function createUpperDownSvgPath() {
	let upperDown = "";
	upperDown += "m xx1,xy1 ";
	upperDown += "a xr4 xr4 0 0 1 xr4 xr4 ";
	upperDown += "v xl3 ";
	upperDown += "a xr3 xr3 0 0 1 -xr3 xr3 ";
	upperDown += "h -xl2 ";
	upperDown += "a xr2 xr2 0 0 0 -xr2 xr2 ";
	upperDown += "v xl1 ";
	upperDown += "a xr1 xr1 0 0 0 xr1 xr1 ";
	return replaceValues(upperDown);
}

function createLowerDownSvgPath() {
	let lowerDown = "";
	lowerDown += "m xx1,xy1 ";
	lowerDown += "a xr1 xr1 0 0 1 xr1 xr1 ";
	lowerDown += "v xl1 ";
	lowerDown += "a xr2 xr2 0 0 1  -xr2 xr2 ";
	lowerDown += "h -xl2 ";
	lowerDown += "a xr3 xr3 0 0 0  -xr3 xr3 ";
	lowerDown += "v xl3 ";
	lowerDown += "a xr4 xr4 0 0 0 xr4 xr4 ";
	return replaceValues(lowerDown);
}

function createLowerUpSvgPath() {
	let lowerUp = "";
	lowerUp += "m xx1,xy1 ";
	lowerUp += "a xr4 xr4 0 0 0 xr4 -xr4 ";
	lowerUp += "v -xl3 ";
	lowerUp += "a xr3 xr3 0 0 0  -xr3 -xr3 ";
	lowerUp += "h -xl2 ";
	lowerUp += "a xr2 xr2 0 0 1  -xr2 -xr2 ";
	lowerUp += "v -xl1 ";
	lowerUp += "a xr1 xr1 0 0 1 xr1 -xr1 ";
	return replaceValues(lowerUp);
}

function createRightRightSvgPath() {
	let rightRight = "";
	rightRight += "m xx1,xy1 ";
	rightRight += "a xr1 xr1 0 0 0 xr1  xr1 ";
	rightRight += "h xl1 ";
	rightRight += "a xr2 xr2 0 0 0 xr2 -xr2 ";
	rightRight += "v -xl2 ";
	rightRight += "a xr3 xr3 0 0 1 xr3 -xr3 ";
	rightRight += "h xl3 ";
	rightRight += "a xr4 xr4 0 0 1 xr4  xr4 ";
	return replaceValues(rightRight);
}

function createRightLeftSvgPath() {
	let rightLeft = "";
	rightLeft += "m xx1,xy1 ";
	rightLeft += "a xr4 xr4 0 0 1 -xr4  xr4 ";
	rightLeft += "h -xl3 ";
	rightLeft += "a xr3 xr3 0 0 1 -xr3 -xr3 ";
	rightLeft += "v -xl2 ";
	rightLeft += "a xr2 xr2 0 0 0 -xr2 -xr2 ";
	rightLeft += "h -xl1 ";
	rightLeft += "a xr1 xr1 0 0 0 -xr1  xr1 ";
	return replaceValues(rightLeft);
}

function createLeftLeftSvgPath() {
	let leftLeft = "";
	leftLeft += "m xx1,xy1 ";
	leftLeft += "a xr1 xr1 0 0 1 -xr1 xr1 ";
	leftLeft += "h -xl1 ";
	leftLeft += "a xr2 xr2 0 0 1 -xr2  -xr2 ";
	leftLeft += "v -xl2 ";
	leftLeft += "a xr3 xr3 0 0 0 -xr3  -xr3 ";
	leftLeft += "h -xl3 ";
	leftLeft += "a xr4 xr4 0 0 0 -xr4 xr4 ";
	return replaceValues(leftLeft);
}

function createLeftRightSvgPath() {
	let leftRight = "";
	leftRight += "m xx1,xy1 ";
	leftRight += "a xr4 xr4 0 0 0 xr4 xr4 ";
	leftRight += "h xl3 ";
	leftRight += "a xr3 xr3 0 0 0 xr3  -xr3 ";
	leftRight += "v -xl2 ";
	leftRight += "a xr2 xr2 0 0 1 xr2 -xr2 ";
	leftRight += "h xl1 ";
	leftRight += "a xr1 xr1 0 0 1 xr1 xr1 ";
	return replaceValues(leftRight);
}

function createRadiusLeftUpperSvgPath(startX, startY, radius) {
	return createRadiusGenericSvgPath(startX, startY, radius, 1, "", "-");
}

function createRadiusRightUpperSvgPath(startX, startY, radius) {
	return createRadiusGenericSvgPath(startX, startY, radius, 1, "", "");
}

function createRadiusLeftLowerSvgPath(startX, startY, radius) {
	return createRadiusGenericSvgPath(startX, startY, radius, 0, "", "");
}

function createRadiusRightLowerSvgPath(startX, startY, radius) {
	return createRadiusGenericSvgPath(startX, startY, radius, 1, "-", "");
}

function createRadiusGenericSvgPath(startX, startY, radius, sf, xRadiusMinus, yRadiusMinus) {
	return "M " + startX + " " + startY + " a " + radius + " " + radius + " 0 0 " + sf + " " + xRadiusMinus + radius + " " + yRadiusMinus +radius + " ";
}

function replaceValues(input) {
	return input.replaceAll("xr1",  metadata.radius1)
			    .replaceAll("xr2",  metadata.radius2)
			    .replaceAll("xr3",  metadata.radius3)
			    .replaceAll("xr4",  metadata.radius4)
			    .replaceAll("xx1",  "0")
			    .replaceAll("xy1",  "0")
			    .replaceAll("xl1",  metadata.length1)
			    .replaceAll("xl2",  metadata.length2)
			    .replaceAll("xl3",  metadata.length3);
}

/*********************************************** SVG Path Elements END ************************************************/

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/*********************************************** GUI Event Handler BEGIN **********************************************/

function cabinetLengthChanged(callCReateModelAndDrawPreview = true) {
	if (genericChanged("cabinetLength", "cabinetLength", checkNumberRange, 2 * metadata.diffInnenAussen)) {
		if (callCReateModelAndDrawPreview) {
			createModel();
			drawPreview();
		}
	}
}

function cabinetWidthChanged(callCReateModelAndDrawPreview = true) {
	if (genericChanged("cabinetWidth", "cabinetWidth", checkNumberRange, 2 * metadata.diffInnenAussen)) {
		if (callCReateModelAndDrawPreview) {
			createModel();
			drawPreview();
		}
	}
}

function cabinetHeightChanged(callCReateModelAndDrawPreview = true) {
	if (genericChanged("cabinetHeight", "cabinetHeight", checkNumberRange, 2 * metadata.diffInnenAussen)) {
		if (callCReateModelAndDrawPreview) {
			createModel();
			drawPreview();
		}
	}
}

function processAlsoFloorChanged() {
	metadata.processAlsoFloor = document.getElementById("processAlsoFloor").checked;
	createModel();
	drawPreview();
}

function helperLinesChanged() {
	metadata.helperLines = document.getElementById("helperLines").checked;
	createModel();
	drawPreview();
}

function materialThicknessChanged() {
	let materialThickness = parseFloat(document.querySelector('input[name="materialThicknessRadio"]:checked').value);
	metadata.materialThickness = materialThickness;
	calculateMetadata();
	checkMaterialThicknessRadioButton(materialThickness);
	createModel();
	drawPreview();
}

function genericChanged(elementId, metaDataFieldName, checkFkt, addNumericValue) {
	if (document.getElementById(elementId + "OutsideDimension")) {
		document.getElementById(elementId + "OutsideDimension").innerHTML = "";
	}
	let intValue = parseInt(document.getElementById(elementId).value);
	if (!isNaN(intValue)) {
		document.getElementById(elementId).value = intValue;
		intValue += addNumericValue;
	}
	let checkFktResult = true;
	if (checkFkt) {
		let checkFktReturn = checkFkt(intValue);
		checkFktResult = checkFktReturn.checkResult;
		if (!checkFktResult && document.getElementById(elementId + "ErrorMsg")) {
			document.getElementById(elementId + "ErrorMsg").innerHTML = checkFktReturn.errorMessage;
		}
	}
	if (!isNaN(intValue) && checkFktResult) {
		document.getElementById(elementId).style.backgroundColor = "";
		if (document.getElementById(elementId + "ErrorMsg")) {
			document.getElementById(elementId + "ErrorMsg").innerHTML = "";
		}
		metadata[metaDataFieldName] = intValue;
		if (document.getElementById(elementId + "OutsideDimension")) {
			document.getElementById(elementId + "OutsideDimension").innerHTML = intValue.toString();
		}
		return true;
	} else {
		document.getElementById(elementId).style.backgroundColor = "#d87979";
		return false;
	}
}

function checkNumberRange(toCheck) {
	let toCheckInt = parseInt(toCheck);

	if (isNaN(toCheckInt)) {
		return {
			checkResult: false,
			errorMessage: "natürliche Zahl zwischen " + metadata.minSideLength + " und " + metadata.maxSideLength + "."
		};
	}

	let checkResultBool = toCheckInt >= metadata.minSideLength && toCheckInt <= metadata.maxSideLength;
	return {
		checkResult: checkResultBool,
		errorMessage: "natürliche Zahl zwischen " + metadata.minSideLength + " und " + metadata.maxSideLength + "."
	};
}

function download(data, filename, type) {
	var file = new Blob([data], {type: type});
	if (window.navigator.msSaveOrOpenBlob) // IE10+
		window.navigator.msSaveOrOpenBlob(file, filename);
	else { // Others
		var a = document.createElement("a"),
				url = URL.createObjectURL(file);
		a.href = url;
		a.download = filename;
		document.body.appendChild(a);
		a.click();
		setTimeout(function() {
			document.body.removeChild(a);
			window.URL.revokeObjectURL(url);
		}, 0);
	}
}

function downloadDXF() {
	let helperLines = metadata.helperLines;

	if (helperLines) {
		metadata.helperLines = false;
		createModel();
	}

	let dxfExp = makerjs.exporter.toDXF(model, {
			usePOLYLINE: true,
			units: makerjs.unitType.Millimeter,
		});
	download(dxfExp, getDateStringForFilename() + "_Click_Vitrine__im_" + (metadata.cabinetLength - (2 * metadata.diffInnenAussen)) + "x" + (metadata.cabinetWidth - (2 * metadata.diffInnenAussen)) + "x" + (metadata.cabinetHeight - (2 * metadata.diffInnenAussen)) + "_" + metadata.materialThickness + "mm_" + (metadata.processAlsoFloor ? "mit_Boden" : "ohne_Boden") + "_PathLength" + metadata.modellength.toFixed(0) + "mm_SurfaceArea_" + (calculateSurfaceArea() / (10 * 10)).toFixed(0) + "cmq.dxf", "dxf")

	if (helperLines) {
		metadata.helperLines = true;
		createModel();
		drawPreview();
	}
}

function downloadSVG() {
	let helperLines = metadata.helperLines;

	if (helperLines) {
		metadata.helperLines = false;
		createModel();
	}

	download(convertSVG(), getDateStringForFilename() + "_Click_Vitrine__im_" + (metadata.cabinetLength - (2 * metadata.diffInnenAussen)) + "x" + (metadata.cabinetWidth - (2 * metadata.diffInnenAussen)) + "x" + (metadata.cabinetHeight - (2 * metadata.diffInnenAussen)) + "_" + metadata.materialThickness + "mm_" + (metadata.processAlsoFloor ? "mit_Boden" : "ohne_Boden") + "_PathLength" + metadata.modellength.toFixed(0) + "mm_SurfaceArea_" + (calculateSurfaceArea() / (10 * 10)).toFixed(0) + "cmq.svg", "svg")

	if (helperLines) {
		metadata.helperLines = true;
		createModel();
		drawPreview();
	}
}

function convertSVG() {
	return '<?xml version="1.0" encoding="UTF-8"?>' +
			makerjs.exporter.toSVG(model, {
				units: makerjs.unitType.Millimeter,
				svgAttrs: {
					"width": (metadata.totalWidth + "mm"),
					"height": (metadata.totalHeight + "mm"),
					"xmlns": "http://www.w3.org/2000/svg",
					"xmlns:xlink": "http://www.w3.org/1999/xlink",
					"version": "1.1",
					"baseProfile": "full"
				}
			}) + "\n";
}

/*********************************************** GUI Event Handler END ************************************************/

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/*********************************************** Helper BEGIN *********************************************************/

function getDateStringForFilename() {
	let currentdate = new Date();
	return getYears(currentdate) + "-" + getMonths(currentdate) + "-" + getDays(currentdate);
}

function getYears(date) {
	return date.getFullYear();
}

function getMonths(date) {
	return (((date.getMonth()+1) < 10) ? "0" : "") + (date.getMonth()+1);
}

function getDays(date) {
	return ((date.getDate() < 10) ? "0" : "") + date.getDate();
}

/*********************************************** Helper END ***********************************************************/

</script>
</body>
</html>